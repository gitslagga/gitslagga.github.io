<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="E1ct36DyjSpaeX5NMAVsyzCjDs8-dQxGThgvw2i1yg0">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"slagga.top","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.21.0","exturl":true,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.21.0/config.min.js"></script>

    <meta name="description" content="mysql服务器逻辑架构每个连接都会在mysql服务端产生一个线程（内部通过线程池管理线程），比如一个select语句进入，mysql首先会在查询缓存中查找是否缓存了这个select的结果集，如果没有则继续执行 解析、优化、执行的过程；否则会之间从缓存中获取结果集。">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解 MySQL —— 锁、事务与并发控制">
<meta property="og:url" content="https://slagga.top/2018/06/mysql-transaction/index.html">
<meta property="og:site_name" content="计算机那些事">
<meta property="og:description" content="mysql服务器逻辑架构每个连接都会在mysql服务端产生一个线程（内部通过线程池管理线程），比如一个select语句进入，mysql首先会在查询缓存中查找是否缓存了这个select的结果集，如果没有则继续执行 解析、优化、执行的过程；否则会之间从缓存中获取结果集。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2018-06-19T08:34:30.000Z">
<meta property="article:modified_time" content="2025-06-06T06:13:40.914Z">
<meta property="article:author" content="Slagga">
<meta property="article:tag" content="Blog, HTML, CSS, JavaScript, Python, PHP, Java, Go, Redis, MySQL, Node.js, React, Vuejs, Git, Programming, Web Development, Blockchain">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://slagga.top/2018/06/mysql-transaction/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://slagga.top/2018/06/mysql-transaction/","path":"2018/06/mysql-transaction/","title":"深入理解 MySQL —— 锁、事务与并发控制"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>深入理解 MySQL —— 锁、事务与并发控制 | 计算机那些事</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0E2T2VNH5S"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-0E2T2VNH5S","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.21.0/third-party/analytics/google-analytics.min.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">计算机那些事</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">软件开发、定制和合作。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">229</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">78</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">28</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#mysql%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84"><span class="nav-number">1.</span> <span class="nav-text">mysql服务器逻辑架构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#mysql%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E2%80%94%E2%80%94%E5%85%B1%E4%BA%AB%E9%94%81%E3%80%81%E6%8E%92%E4%BB%96%E9%94%81"><span class="nav-number">2.</span> <span class="nav-text">mysql并发控制——共享锁、排他锁</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B1%E4%BA%AB%E9%94%81"><span class="nav-number">2.1.</span> <span class="nav-text">共享锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%92%E4%BB%96%E9%94%81"><span class="nav-number">2.2.</span> <span class="nav-text">排他锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%81%E7%AD%96%E7%95%A5"><span class="nav-number">2.3.</span> <span class="nav-text">锁策略</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1"><span class="nav-number">3.</span> <span class="nav-text">事务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84ACID"><span class="nav-number">3.1.</span> <span class="nav-text">事务的ACID</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="nav-number">4.</span> <span class="nav-text">隔离级别</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#READ-UNCOMMITTED-%E6%9C%AA%E6%8F%90%E4%BA%A4%E8%AF%BB-%E5%8F%AF%E8%84%8F%E8%AF%BB"><span class="nav-number">4.1.</span> <span class="nav-text">READ UNCOMMITTED(未提交读,可脏读)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#READ-COMMITTED-%E6%8F%90%E4%BA%A4%E8%AF%BB%E6%88%96%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB%EF%BC%8C%E5%B9%BB%E8%AF%BB"><span class="nav-number">4.2.</span> <span class="nav-text">READ COMMITTED(提交读或不可重复读，幻读)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#REPEATABLE-READ-%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB"><span class="nav-number">4.3.</span> <span class="nav-text">REPEATABLE READ(可重复读)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SERIALIZABLE-%E5%8F%AF%E4%B8%B2%E8%A1%8C%E5%8C%96"><span class="nav-number">4.4.</span> <span class="nav-text">SERIALIZABLE(可串行化)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6-MVCC"><span class="nav-number">5.</span> <span class="nav-text">多版本并发控制-MVCC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%99%E9%94%81-recordLock-gapLock-next-key-lock"><span class="nav-number">5.1.</span> <span class="nav-text">写锁-recordLock,gapLock,next key lock</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MVCC-select%E6%97%A0%E9%94%81%E6%93%8D%E4%BD%9C-%E4%B8%8E-%E7%BB%B4%E6%8A%A4%E7%89%88%E6%9C%AC%E5%8F%B7"><span class="nav-number">5.2.</span> <span class="nav-text">MVCC select无锁操作 与 维护版本号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%84%8F%E8%AF%BB-vs-%E5%B9%BB%E8%AF%BB-vs-%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB"><span class="nav-number">5.3.</span> <span class="nav-text">脏读 vs 幻读 vs 不可重复读</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81rr%E7%BA%A7%E5%88%AB%E7%BB%9D%E5%AF%B9%E4%B8%8D%E4%BA%A7%E7%94%9F%E5%B9%BB%E8%AF%BB%EF%BC%9F"><span class="nav-number">5.4.</span> <span class="nav-text">如何保证rr级别绝对不产生幻读？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mysql%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98"><span class="nav-number">5.5.</span> <span class="nav-text">mysql死锁问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mysql%E4%B8%AD%E7%9A%84%E4%BA%8B%E5%8A%A1"><span class="nav-number">5.6.</span> <span class="nav-text">mysql中的事务</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Slagga"
      src="https://avatars.githubusercontent.com/u/19620432">
  <p class="site-author-name" itemprop="name">Slagga</p>
  <div class="site-description" itemprop="description">计算机那些事 - 个人博客网站，涉及的领域包括IT技术、区块链行业、产品思维、运营能力、个人观点等</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">229</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">78</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dpdHNsYWdnYQ==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;gitslagga"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOnNsYWdnYUBkdWNrLmNvbQ==" title="E-Mail → mailto:slagga@duck.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://slagga.top/2018/06/mysql-transaction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/19620432">
      <meta itemprop="name" content="Slagga">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="计算机那些事">
      <meta itemprop="description" content="计算机那些事 - 个人博客网站，涉及的领域包括IT技术、区块链行业、产品思维、运营能力、个人观点等">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="深入理解 MySQL —— 锁、事务与并发控制 | 计算机那些事">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          深入理解 MySQL —— 锁、事务与并发控制
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-06-19 16:34:30" itemprop="dateCreated datePublished" datetime="2018-06-19T16:34:30+08:00">2018-06-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-06 14:13:40" itemprop="dateModified" datetime="2025-06-06T14:13:40+08:00">2025-06-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="mysql服务器逻辑架构"><a href="#mysql服务器逻辑架构" class="headerlink" title="mysql服务器逻辑架构"></a>mysql服务器逻辑架构</h1><p>每个连接都会在mysql服务端产生一个线程（内部通过线程池管理线程），比如一个select语句进入，mysql首先会在查询缓存中查找是否缓存了这个select的结果集，如果没有则继续执行 解析、优化、执行的过程；否则会之间从缓存中获取结果集。</p>
<span id="more"></span>

<h1 id="mysql并发控制——共享锁、排他锁"><a href="#mysql并发控制——共享锁、排他锁" class="headerlink" title="mysql并发控制——共享锁、排他锁"></a>mysql并发控制——共享锁、排他锁</h1><h2 id="共享锁"><a href="#共享锁" class="headerlink" title="共享锁"></a>共享锁</h2><p>共享锁也称为读锁，读锁允许多个连接可以同一时刻并发的读取同一资源,互不干扰；</p>
<h2 id="排他锁"><a href="#排他锁" class="headerlink" title="排他锁"></a>排他锁</h2><p>排他锁也称为写锁，一个写锁会阻塞其他的写锁或读锁，保证同一时刻只有一个连接可以写入数据，同时防止其他用户对这个数据的读写。</p>
<h2 id="锁策略"><a href="#锁策略" class="headerlink" title="锁策略"></a>锁策略</h2><p>锁的开销是较为昂贵的，锁策略其实就是保证了线程安全的同时获取最大的性能之间的平衡策略。</p>
<ul>
<li><strong>mysql锁策略：talbe lock(表锁)</strong></li>
</ul>
<p>表锁是mysql最基本的锁策略，也是开销最小的锁，它会锁定整个表；</p>
<p>具体情况是：若一个用户正在执行写操作，会获取排他的“写锁”，这可能会锁定整个表，阻塞其他用户的读、写操作；</p>
<p>若一个用户正在执行读操作，会先获取共享锁“读锁”，这个锁运行其他读锁并发的对这个表进行读取，互不干扰。只要没有写锁的进入，读锁可以是并发读取统一资源的。</p>
<p>通常发生在DDL语句\DML不走索引的语句中，比如这个DML update table set columnA&#x3D;”A” where columnB&#x3D;“B”. <br>如果columnB字段不存在索引（或者不是组合索引前缀），会锁住所有记录也就是锁表。如果语句的执行能够执行一个columnB字段的索引，那么会锁住满足where的行(行锁)。</p>
<ul>
<li><strong>mysql锁策略：row lock(行锁)</strong></li>
</ul>
<p>行锁可以最大限度的支持并发处理，当然也带来了最大开销，顾名思义，行锁的粒度实在每一条行数据。</p>
<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p><strong>事务就是一组原子性的sql，或者说一个独立的工作单元。</strong> <br><strong>事务就是说，要么mysql引擎会全部执行这一组sql语句，要么全部都不执行（比如其中一条语句失败的话）。</strong></p>
<p>比如，tim要给bill转账100块钱： <br>1.检查tim的账户余额是否大于100块； <br>2.tim的账户减少100块； <br>3.bill的账户增加100块； <br>这三个操作就是一个事务，必须打包执行，要么全部成功，要么全部不执行，其中任何一个操作的失败都会导致所有三个操作“不执行”——回滚。</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> employees;</span><br><span class="line">USE employees;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> TABLE <span class="symbol">`employees`</span>.<span class="symbol">`account`</span> (</span><br><span class="line">  <span class="symbol">`id`</span> BIGINT (<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="symbol">`p_name`</span> VARCHAR (<span class="number">4</span>),</span><br><span class="line">  <span class="symbol">`p_money`</span> DECIMAL (<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="number">0</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`id`</span>)</span><br><span class="line">) ;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="symbol">`employees`</span>.<span class="symbol">`account`</span> (<span class="symbol">`id`</span>, <span class="symbol">`p_name`</span>, <span class="symbol">`p_money`</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;tim&#x27;</span>, <span class="string">&#x27;200&#x27;</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="symbol">`employees`</span>.<span class="symbol">`account`</span> (<span class="symbol">`id`</span>, <span class="symbol">`p_name`</span>, <span class="symbol">`p_money`</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;bill&#x27;</span>, <span class="string">&#x27;200&#x27;</span>); </span><br><span class="line"></span><br><span class="line">START TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> p_money <span class="keyword">FROM</span> account <span class="keyword">WHERE</span> p_name=<span class="string">&quot;tim&quot;</span>;-- step1</span><br><span class="line"><span class="keyword">UPDATE</span> account <span class="keyword">SET</span> p_money=p_money<span class="number">-100</span> <span class="keyword">WHERE</span> p_name=<span class="string">&quot;tim&quot;</span>;-- step2</span><br><span class="line"><span class="keyword">UPDATE</span> account <span class="keyword">SET</span> p_money=p_money+<span class="number">100</span> <span class="keyword">WHERE</span> p_name=<span class="string">&quot;bill&quot;</span>;-- step3</span><br><span class="line">COMMIT;</span><br></pre></td></tr></table></figure>

<p>一个良好的事务系统，必须满足ACID特点：</p>
<h2 id="事务的ACID"><a href="#事务的ACID" class="headerlink" title="事务的ACID"></a>事务的ACID</h2><ul>
<li><p><strong>A:atomiciy原子性</strong> <br><strong>一个事务必须保证其中的操作要么全部执行，要么全部回滚，不可能存在只执行了一部分这种情况出现。</strong></p>
</li>
<li><p><strong>C:consistency一致性</strong> <br><strong>数据必须保证从一种一致性的状态转换为另一种一致性状态</strong>。 <br>比如上一个事务中执行了第二步时系统崩溃了，数据也不会出现bill的账户少了100块，但是tim的账户没变的情况。要么维持原装（全部回滚），要么bill少了100块同时tim多了100块，只有这两种一致性状态的</p>
</li>
<li><p><strong>I：isolation隔离性</strong> <br><strong>在一个事务未执行完毕时，通常会保证其他Session 无法看到这个事务的执行结果</strong></p>
</li>
<li><p><strong>D:durability持久性</strong> <br><strong>事务一旦commit，则数据就会保存下来，即使提交完之后系统崩溃，数据也不会丢失。</strong></p>
</li>
</ul>
<h1 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h1><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">查看系统隔离级别：</span><br><span class="line"><span class="keyword">select</span> @@<span class="keyword">global</span>.tx_isolation;</span><br><span class="line">查看当前会话隔离级别</span><br><span class="line"><span class="keyword">select</span> @@tx_isolation;</span><br><span class="line">设置当前会话隔离级别</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">session</span> <span class="keyword">TRANSACTION</span> <span class="keyword">ISOLATION</span> <span class="keyword">LEVEL</span> <span class="keyword">serializable</span>;</span><br><span class="line">设置全局系统隔离级别</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> <span class="keyword">TRANSACTION</span> <span class="keyword">ISOLATION</span> <span class="keyword">LEVEL</span> <span class="keyword">READ</span> <span class="keyword">UNCOMMITTED</span>;</span><br></pre></td></tr></table></figure>

<h2 id="READ-UNCOMMITTED-未提交读-可脏读"><a href="#READ-UNCOMMITTED-未提交读-可脏读" class="headerlink" title="READ UNCOMMITTED(未提交读,可脏读)"></a>READ UNCOMMITTED(未提交读,可脏读)</h2><p><strong>事务中的修改，即使没有提交，对其他会话也是可见的。</strong> <br><strong>可以读取未提交的数据</strong>——<strong>脏读</strong>。脏读会导致很多问题，一般不适用这个隔离级别。 <br>实例：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ------------------------- read-uncommitted实例 ------------------------------</span></span><br><span class="line"><span class="comment">-- 设置全局系统隔离级别</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> <span class="keyword">TRANSACTION</span> <span class="keyword">ISOLATION</span> <span class="keyword">LEVEL</span> <span class="keyword">READ</span> <span class="keyword">UNCOMMITTED</span>;</span><br><span class="line"><span class="comment">-- Session A</span></span><br><span class="line"><span class="keyword">START</span> <span class="keyword">TRANSACTION</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">USER</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> <span class="keyword">USER</span> <span class="keyword">SET</span> <span class="type">NAME</span>=&quot;READ UNCOMMITTED&quot;;</span><br><span class="line"><span class="comment">-- commit;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Session B</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">USER</span>;</span><br><span class="line"></span><br><span class="line">//SessionB Console 可以看到<span class="keyword">Session</span> A未提交的事物处理，在另一个<span class="keyword">Session</span> 中也看到了，这就是所谓的脏读</span><br><span class="line">id  <span class="type">name</span></span><br><span class="line"><span class="number">2</span>   <span class="keyword">READ</span> <span class="keyword">UNCOMMITTED</span></span><br><span class="line"><span class="number">34</span>  <span class="keyword">READ</span> <span class="keyword">UNCOMMITTED</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="READ-COMMITTED-提交读或不可重复读，幻读"><a href="#READ-COMMITTED-提交读或不可重复读，幻读" class="headerlink" title="READ COMMITTED(提交读或不可重复读，幻读)"></a>READ COMMITTED(提交读或不可重复读，幻读)</h2><p>一般数据库都默认使用这个隔离级别（mysql不是），<strong>这个隔离级别保证了一个事务如果没有完全成功（commit执行完），事务中的操作对其他会话是不可见的</strong>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ------------------------- read-cmmitted实例 ------------------------------</span></span><br><span class="line"><span class="comment">-- 设置全局系统隔离级别</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> TRANSACTION ISOLATION LEVEL READ  COMMITTED;</span><br><span class="line"><span class="comment">-- Session A</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">USER</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> <span class="keyword">USER</span> <span class="keyword">SET</span> NAME<span class="operator">=</span>&quot;READ COMMITTED&quot;;</span><br><span class="line"><span class="comment">-- COMMIT;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Session B</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">USER</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>Console OUTPUT:</span><br><span class="line">id  name</span><br><span class="line"><span class="number">2</span>   READ UNCOMMITTED</span><br><span class="line"><span class="number">34</span>  READ UNCOMMITTED</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">---------------------------------------------------</span></span><br><span class="line"><span class="comment">-- 当 Session  A执行了commit，Session B得到如下结果：</span></span><br><span class="line">id  name</span><br><span class="line"><span class="number">2</span>   READ COMMITTED</span><br><span class="line"><span class="number">34</span>  READ COMMITTED</span><br></pre></td></tr></table></figure>

<p>也就验证了<strong>read committed</strong>级别在事物未完成commit操作之前修改的数据对其他Session 不可见，执行了commit之后才会对其他Session 可见。 <br>我们可以看到Session B两次查询得到了不同的数据。</p>
<p><strong>read committed隔离级别解决了脏读的问题，但是会对其他Session 产生两次不一致的读取结果（因为另一个Session 执行了事务，一致性变化）。</strong></p>
<h2 id="REPEATABLE-READ-可重复读"><a href="#REPEATABLE-READ-可重复读" class="headerlink" title="REPEATABLE READ(可重复读)"></a>REPEATABLE READ(可重复读)</h2><p>一个事务中多次执行统一读SQL,返回结果一样。 <br>这个隔离级别解决了脏读的问题，幻读问题。这里指的是innodb的rr级别，innodb中使用next-key锁对”当前读”进行加锁，锁住行以及可能产生幻读的插入位置，阻止新的数据插入产生幻行。 <br>下文中详细分析。</p>
<p>具体请参考mysql手册</p>
<blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly9kZXYubXlzcWwuY29tL2RvYy9yZWZtYW4vNS43L2VuL2lubm9kYi1zdG9yYWdlLWVuZ2luZS5odG1s">https://dev.mysql.com/doc/refman/5.7/en/innodb-storage-engine.html<i class="fa fa-external-link-alt"></i></span></p>
</blockquote>
<h2 id="SERIALIZABLE-可串行化"><a href="#SERIALIZABLE-可串行化" class="headerlink" title="SERIALIZABLE(可串行化)"></a>SERIALIZABLE(可串行化)</h2><p>最强的隔离级别，通过给事务中每次读取的行加锁，写加写锁，保证不产生幻读问题，但是会导致大量超时以及锁争用问题。</p>
<h1 id="多版本并发控制-MVCC"><a href="#多版本并发控制-MVCC" class="headerlink" title="多版本并发控制-MVCC"></a>多版本并发控制-MVCC</h1><p>MVCC(multiple-version-concurrency-control）是个<strong>行级锁</strong>的变种，它在<strong>普通读情况下避免了加锁操作，因此开销更低</strong>。 <br>虽然实现不同，但通常都是实现<strong>非阻塞读</strong>，对于<strong>写操作只锁定必要的行</strong>。</p>
<ul>
<li><strong>一致性读 （就是读取快照）</strong> <br>select * from table ….;</li>
<li><strong>当前读(就是读取实际的持久化的数据)</strong> <br>特殊的读操作，插入&#x2F;更新&#x2F;删除操作，属于当前读，处理的都是当前的数据，需要加锁。 <br>select * from table where ? lock in share mode; <br>select * from table where ? for update; <br>insert; <br>update ; <br>delete;</li>
</ul>
<p><strong>注意：select …… from where…… （没有额外加锁后缀）使用MVCC，保证了读快照(mysql称为consistent read)，所谓一致性读或者读快照就是读取当前事务开始之前的数据快照，在这个事务开始之后的更新不会被读到。详细情况下文select的详述。</strong></p>
<p><strong>对于加锁读SELECT with FOR UPDATE(排他锁) or LOCK IN SHARE MODE(共享锁)、update、delete语句，要考虑是否是唯一索引的等值查询。</strong></p>
<h2 id="写锁-recordLock-gapLock-next-key-lock"><a href="#写锁-recordLock-gapLock-next-key-lock" class="headerlink" title="写锁-recordLock,gapLock,next key lock"></a>写锁-recordLock,gapLock,next key lock</h2><p><strong>对于使用到唯一索引 等值查询：比如，where columnA&#x3D;”…” ，如果columnA上的索引被使用到，</strong> <br><strong>那么会在满足where的记录上加行锁(for update是排他锁,lock in shared 是共享锁，其他写操作加排他锁)。这里是行级锁，record lock。</strong></p>
<p><strong>对于范围查询（使用非唯一的索引）：</strong> <br><strong>比如(做范围查询)：where columnA between 10 and 30 ,会导致其他会话中10以后的数据都无法插入(next key lock),从而解决了幻读问题。</strong></p>
<p><strong>这里是next key lock 会包括涉及到的所有行。</strong> <br><strong>next key lock&#x3D;recordLock+gapLock，不仅锁住相关数据，而且锁住边界，从而彻底避免幻读</strong>。<span class="exturl" data-url="aHR0cDovL2hlZGVuZ2NoZW5nLmNvbS8/cD03NzEjX1RvYzM3NDY5ODMyMg==">可点击查看这篇推荐文章<i class="fa fa-external-link-alt"></i></span></p>
<p><strong>对于没有索引</strong> <br><strong>锁表</strong> <br>通常发生在DDL语句\DML不走索引的语句中，比如这个DML update table set columnA&#x3D;”A” where columnB&#x3D;“B”. <br>如果columnB字段不存在索引（或者不是组合索引前缀），会锁住所有记录也就是锁表。如果语句的执行能够执行一个columnB字段的索引，那么会锁住满足where的行(行锁)。</p>
<p><strong>INNODB的MVCC通常是通过在每行数据后边保存两个隐藏的列来实现(其实是三列，第三列是用于事务回滚，此处略去)，</strong> <br><strong>一个保存了行的创建版本号，另一个保存了行的更新版本号（上一次被更新数据的版本号）</strong> <br>这个版本号是每个事务的版本号，递增的。</p>
<p>这样保证了innodb对读操作不需要加锁也能保证正确读取数据。</p>
<h2 id="MVCC-select无锁操作-与-维护版本号"><a href="#MVCC-select无锁操作-与-维护版本号" class="headerlink" title="MVCC select无锁操作 与 维护版本号"></a>MVCC select无锁操作 与 维护版本号</h2><p>下边在mysql默认的Repeatable Read隔离级别下，具体看看MVCC操作：</p>
<ul>
<li><p><strong>Select（快照读，所谓读快照就是读取当前事务之前的数据。）：</strong> <br>a.<strong>InnoDB只select查找版本号早于当前版本号的数据行</strong>，这样保证了读取的数据要么是在这个事务开始之前就已经commit了的（早于当前版本号），要么是在这个事务自身中执行创建操作的数据（等于当前版本号）。</p>
<p>b.查找行的更新版本号要么未定义，要么大于当前的版本号(为了保证事务可以读到老数据)，这样保证了事务读取到在当前事务开始之后未被更新的数据。 <br>注意： 这里的select不能有for update、lock in share 语句。 <br>总之要只返回满足以下条件的行数据，达到了快照读的效果：</p>
</li>
</ul>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(行创建版本号&lt; =当前版本号 <span class="symbol">&amp;&amp;</span> (行更新版本号==null or 行更新版本号&gt;当前版本号 ) )</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>Insert</strong></p>
<p>InnoDB为这个事务中新插入的行，保存当前事务版本号的行作为行的行创建版本号。</p>
</li>
<li><p><strong>Delete</strong> <br>InnoDB为每一个删除的行保存当前事务版本号，作为行的删除标记。</p>
</li>
<li><p><strong>Update</strong></p>
<p>将存在两条数据，保持当前版本号作为更新后的数据的新增版本号，同时保存当前版本号作为老数据行的更新版本号。</p>
</li>
</ul>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当前版本号—写—&gt;新数据行创建版本号 <span class="meta">&amp;&amp; 当前版本号—写—&gt;老数据更新版本号();</span></span><br></pre></td></tr></table></figure>

<h2 id="脏读-vs-幻读-vs-不可重复读"><a href="#脏读-vs-幻读-vs-不可重复读" class="headerlink" title="脏读 vs 幻读 vs 不可重复读"></a>脏读 vs 幻读 vs 不可重复读</h2><p><strong>脏读</strong>：<strong>一事务未提交的中间状态的更新数据 被其他会话读取到。</strong> 当一个事务正在访问数据，并且对数据进行了修改，而这种修改还没有 提交到数据库中(commit未执行)，这时，另外会话也访问这个数据，因为这个数据是还没有提交， 那么另外一个会话读到的这个数据是脏数据，依据脏数据所做的操作也可能是不正确的。</p>
<p><strong>不可重复读</strong>：<strong>简单来说就是在一个事务中读取的数据可能产生变化，ReadCommitted也称为不可重复读</strong>。</p>
<p>在同一事务中，多次读取同一数据返回的结果有所不同。换句话说就是，后续读取可以读到另一会话事务已提交的更新数据。 相反，“可重复读”在同一事务中多次读取数据时，能够保证所读数据一样，也就是，后续读取不能读到另一会话事务已提交的更新数据。</p>
<p><strong>幻读</strong>：会话T1事务中执行一次查询，然后会话T2新插入一行记录，<strong>这行记录恰好可以满足T1所使用的查询的条件</strong>。然后T1又使用相同 的查询再次对表进行检索，但是此时却看到了事务T2刚才插入的新行。这个新行就称为“幻像”，因为对T1来说这一行就像突然 出现的一样。 <br>innoDB的RR级别无法做到完全避免幻读，下文详细分析。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">----------------------------------前置准备----------------------------------------</span></span><br><span class="line">prerequisite：</span><br><span class="line"><span class="comment">-- 创建表</span></span><br><span class="line">mysql&gt;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_bitfly` (</span><br><span class="line">   `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">   `<span class="keyword">value</span>` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">   <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line"> )</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 确保当前隔离级别为默认的RR级别</span></span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> @@<span class="keyword">global</span>.tx_isolation, @@tx_isolation;</span><br><span class="line">+<span class="comment">-----------------------+-----------------+</span></span><br><span class="line">| @@<span class="keyword">global</span>.tx_isolation | @@tx_isolation  |</span><br><span class="line">+<span class="comment">-----------------------+-----------------+</span></span><br><span class="line">| <span class="keyword">REPEATABLE</span>-<span class="keyword">READ</span>       | <span class="keyword">REPEATABLE</span>-<span class="keyword">READ</span> |</span><br><span class="line">+<span class="comment">-----------------------+-----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="comment">---------------------------------------开始--------------------------------------------- </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">session</span> A                                           |   <span class="keyword">session</span> B</span><br><span class="line">                                                    |</span><br><span class="line">                                                    |</span><br><span class="line">mysql&gt; <span class="keyword">START</span> <span class="keyword">TRANSACTION</span>;                           |   mysql&gt; <span class="keyword">START</span> <span class="keyword">TRANSACTION</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)                |   Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)                                        </span><br><span class="line">                                                    |   </span><br><span class="line">                                                    |</span><br><span class="line">mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> test.t_bitfly;                 |   mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> test.t_bitfly; </span><br><span class="line">Empty <span class="keyword">set</span> (<span class="number">0.00</span> sec)                                |   Empty <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">                                                    |</span><br><span class="line">                                                    |   mysql&gt; <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_bitfly <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">                                                    |   Query OK, <span class="number">1</span> <span class="keyword">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">                                                    |</span><br><span class="line">                                                    |</span><br><span class="line">mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> test.t_bitfly;                 |</span><br><span class="line">Empty <span class="keyword">set</span> (<span class="number">0.00</span> sec)                                |</span><br><span class="line">                                                    |</span><br><span class="line">                                                    |   mysql&gt; <span class="keyword">commit</span>;</span><br><span class="line">                                                    |   Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)                                                </span><br><span class="line">mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> test.t_bitfly;                 |</span><br><span class="line">Empty <span class="keyword">set</span> (<span class="number">0.00</span> sec)                                |</span><br><span class="line"><span class="comment">-- 可以看到虽然两次执行结果返回的数据一致，         |</span></span><br><span class="line"><span class="comment">-- 但是不能说明没有幻读。接着看：                   |</span></span><br><span class="line">                                                    |</span><br><span class="line">mysql&gt; <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_bitfly <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;test&#x27;</span>);     |</span><br><span class="line">ERROR <span class="number">1062</span> (<span class="number">23000</span>):                                 |</span><br><span class="line">Duplicate entry <span class="string">&#x27;1&#x27;</span> <span class="keyword">for key</span> <span class="string">&#x27;PRIMARY&#x27;</span>               |</span><br><span class="line">                                                    |</span><br><span class="line"><span class="comment">-- 明明为空的表，为什么说主键重复？——幻读出现 ！！！       |</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="如何保证rr级别绝对不产生幻读？"><a href="#如何保证rr级别绝对不产生幻读？" class="headerlink" title="如何保证rr级别绝对不产生幻读？"></a>如何保证rr级别绝对不产生幻读？</h2><p>在使用的select …where语句中加入 for update(排他锁) 或者 lock in share mode(共享锁)语句来实现。<strong>其实就是锁住了可能造成幻读的数据，阻止数据的写入操作。</strong></p>
<p>其实是因为数据的写入操作(insert 、update)需要先获取写锁，由于可能产生幻读的部分，已经获取到了某种锁，所以要在另外一个会话中获取写锁的前提是当前会话中释放所有因加锁语句产生的锁。</p>
<h2 id="mysql死锁问题"><a href="#mysql死锁问题" class="headerlink" title="mysql死锁问题"></a>mysql死锁问题</h2><p>死锁，就是产生了循环等待链条，我等待你的资源，你却等待我的资源，我们都相互等待，谁也不释放自己占有的资源，导致无线等待下去。 <br>比如：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//<span class="keyword">Session</span> A</span><br><span class="line"><span class="keyword">START</span> <span class="keyword">TRANSACTION</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> account <span class="keyword">SET</span> p_money=p_money<span class="number">-100</span> <span class="keyword">WHERE</span> p_name=&quot;tim&quot;;</span><br><span class="line"><span class="keyword">UPDATE</span> account <span class="keyword">SET</span> p_money=p_money+<span class="number">100</span> <span class="keyword">WHERE</span> p_name=&quot;bill&quot;;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line">//Thread B</span><br><span class="line"><span class="keyword">START</span> <span class="keyword">TRANSACTION</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> account <span class="keyword">SET</span> p_money=p_money+<span class="number">100</span> <span class="keyword">WHERE</span> p_name=&quot;bill&quot;;</span><br><span class="line"><span class="keyword">UPDATE</span> account <span class="keyword">SET</span> p_money=p_money<span class="number">-100</span> <span class="keyword">WHERE</span> p_name=&quot;tim&quot;;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<p>当线程A执行到第一条语句UPDATE account SET p_money&#x3D;p_money-100 WHERE p_name&#x3D;”tim”;锁定了p_name&#x3D;”tim”的行数据；并且试图获取p_name&#x3D;”bill”的数据；</p>
<p>，此时，恰好，线程B也执行到第一条语句：UPDATE account SET p_money&#x3D;p_money+100 WHERE p_name&#x3D;”bill”;</p>
<p>锁定了 p_name&#x3D;”bill”的数据，同时试图获取p_name&#x3D;”tim”的数据； <br>此时，两个线程就进入了死锁，谁也无法获取自己想要获取的资源，进入无线等待中，直到超时！</p>
<p><strong>innodb_lock_wait_timeout 等待锁超时回滚事务：</strong> <br>直观方法是在两个事务相互等待时，当一个等待时间超过设置的某一阀值时，对其中一个事务进行回滚，另一个事务就能继续执行。这种方法简单有效，在innodb中，参数innodb_lock_wait_timeout用来设置超时时间。</p>
<p><strong>wait-for graph算法来主动进行死锁检测：</strong> <br>innodb还提供了wait-for graph算法来主动进行死锁检测，每当加锁请求无法立即满足需要并进入等待时，wait-for graph算法都会被触发。</p>
<p><strong>如何尽可能避免死锁</strong></p>
<p>1）以固定的顺序访问表和行。比如两个更新数据的事务，事务A 更新数据的顺序 为1，2；事务B更新数据的顺序为2，1。这样更可能会造成死锁。</p>
<p>2）大事务拆小。大事务更倾向于死锁，如果业务允许，将大事务拆小。</p>
<p>3）在同一个事务中，尽可能做到一次锁定所需要的所有资源，减少死锁概率。</p>
<p>4）降低隔离级别。如果业务允许，将隔离级别调低也是较好的选择，比如将隔离级别从RR调整为RC，可以避免掉很多因为gap锁造成的死锁。</p>
<p>5）为表添加合理的索引。可以看到如果不走索引将会为表的每一行记录添加上锁，死锁的概率大大增大。</p>
<p><strong>显式锁 与 隐式锁</strong> <br><strong>隐式锁</strong>:我们上文说的锁都属于不需要额外语句加锁的隐式锁。 <br><strong>显示锁</strong>：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">SELECT</span></span> ... LOCK IN SHARE MODE(加共享锁);</span><br><span class="line"><span class="function"><span class="title">SELECT</span></span> ... <span class="keyword">FOR</span> UPDATE(加排他锁);</span><br></pre></td></tr></table></figure>

<p>详情上文已经说过。</p>
<p>通过如下sql可以查看等待锁的情况</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.innodb_trx <span class="keyword">where</span> trx_state<span class="operator">=</span>&quot;lock wait&quot;;</span><br><span class="line">或</span><br><span class="line"><span class="keyword">show</span> engine innodb status;</span><br></pre></td></tr></table></figure>

<h2 id="mysql中的事务"><a href="#mysql中的事务" class="headerlink" title="mysql中的事务"></a>mysql中的事务</h2><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">show <span class="keyword">variables</span> like <span class="comment">&quot;autocommit&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> autocommit=0; <span class="comment">//0表示AutoCommit关闭</span></span><br><span class="line"><span class="keyword">set</span> autocommit=1; <span class="comment">//1表示AutoCommit开启</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>自动提交（AutoCommit，mysql默认）</strong></li>
</ul>
<p>mysql默认采用AutoCommit模式，也就是每个sql都是一个事务，并不需要显示的执行事务。 <br>如果autoCommit关闭，那么每个sql都默认开启一个事务，只有显式的执行“commit”后这个事务才会被提交。</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2018/06/c-c++-script1/" rel="prev" title="使用 malloc 后 free 出错 错误所在">
                  <i class="fa fa-angle-left"></i> 使用 malloc 后 free 出错 错误所在
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2018/06/redis-install/" rel="next" title="Redis 安装异常解决办法">
                  Redis 安装异常解决办法 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2015 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Slagga</span>
  </div>
  <div class="powered-by">由 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9waXNjZXMv">NexT.Pisces</span> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dpdHNsYWdnYQ==" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.21.0/comments.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.21.0/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.21.0/motion.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.21.0/sidebar.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.21.0/next-boot.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.21.0/pjax.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.21.0/third-party/search/local-search.min.js"></script>




  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.21.0/third-party/fancybox.min.js"></script>



  




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"gitslagga","repo":"gitslagga.github.io","client_id":"8b03c773267690e6d402","client_secret":"7b2ef82f50c632cdb14c98b7e5928357974cad97","admin_user":"gitslagga","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"69df4d7add173d0e9e733b43b365109a"}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.21.0/third-party/comments/gitalk.min.js"></script>

</body>
</html>
